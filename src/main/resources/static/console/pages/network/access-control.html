<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘åå•ç®¡ç?- OpenWrt - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">`n    <link rel="stylesheet" href="/console/css/theme.css">`n    <link rel="stylesheet" href="/console/css/dashboard.css">`n    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/theme-manager.js"></script>`n    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹å¯¼èˆªæ ?-->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1><i class="ri-shield-cross-line"></i> é»‘åå•ç®¡ç?/h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="history.back()">
                        <i class="ri-arrow-left-line"></i> è¿”å›
                    </button>
                    <button class="btn btn-primary" onclick="showAddBlacklistModal()">
                        <i class="ri-add-line"></i> æ·»åŠ é»‘åå?                    </button>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);">
                        <i class="ri-shield-cross-line"></i>
                    </div>
                    <div class="status-value" id="blacklistCount">0</div>
                    <div class="status-label">é»‘åå•æ•°é‡?/div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);">
                        <i class="ri-shield-check-line"></i>
                    </div>
                    <div class="status-value" id="enabledCount">0</div>
                    <div class="status-label">å·²å¯ç”?/div>
                </div>
            </div>
            
            <!-- é»‘åå•åˆ—è¡?-->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-list-check"></i> é»‘åå•åˆ—è¡?/h2>
                    <button class="btn btn-secondary" onclick="loadBlacklist()">
                        <i class="ri-refresh-line"></i> åˆ·æ–°
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="blacklistTable">
                            <thead>
                                <tr>
                                    <th>IP åœ°å€</th>
                                    <th>åç§°</th>
                                    <th>æ¥æº</th>
                                    <th>çŠ¶æ€?/th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                                <!-- åŠ¨æ€ç”Ÿæˆ?-->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é»‘åå•æ¨¡æ€æ¡† -->
    <div id="addBlacklistModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ é»‘åå?/h3>
                <button class="modal-close" onclick="hideAddBlacklistModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">IP åœ°å€</label>
                    <input type="text" id="blacklistIp" class="form-input" placeholder="192.168.1.200">
                </div>
                <div class="form-group">
                    <label class="form-label">åç§°</label>
                    <input type="text" id="blacklistName" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¯ç–‘è®¾å¤?>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddBlacklistModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addBlacklist()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script src="/console/common/api-client.js"></script>
    <script src="/console/common/button-manager.js"></script>
    <script src="/console/common/utils.js"></script>
    <script>
        // API å®¢æˆ·ç«¯å®ä¾?        const openwrtApi = new ApiClient('/api/openwrt');

        // é¡µé¢åˆå§‹åŒ?        window.onPageInit = function() {
            loadBlacklist();
        };

        // åŠ è½½é»‘åå•åˆ—è¡?        async function loadBlacklist() {
            try {
                const data = await openwrtApi.get('/blacklist');

                if (data.status === 'success') {
                    renderBlacklistTable(data.data || []);
                    updateStats(data.data || []);
                }
            } catch (error) {
                console.error('åŠ è½½é»‘åå•å¤±è´?', error);
                showToast('åŠ è½½é»‘åå•å¤±è´?, 'error');
            }
        }

        // æ¸²æŸ“é»‘åå•è¡¨æ ?        function renderBlacklistTable(blacklist) {
            const tbody = document.getElementById('blacklistTableBody');
            tbody.innerHTML = '';

            if (!blacklist || blacklist.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— é»‘åå?/td></tr>';
                return;
            }

            blacklist.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.ip || '-'}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.source || '*'}</td>
                    <td>
                        <span class="badge ${item.enabled ? 'badge-success' : 'badge-secondary'}">
                            ${item.enabled ? 'å·²å¯ç”? : 'å·²ç¦ç”?}
                        </span>
                    </td>
                    <td>${formatDate(item.created)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeBlacklist('${item.id}')">
                            <i class="ri-delete-bin-line"></i> ç§»é™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats(blacklist) {
            document.getElementById('blacklistCount').textContent = blacklist.length;
            document.getElementById('enabledCount').textContent = blacklist.filter(item => item.enabled).length;
        }

        // æ ¼å¼åŒ–æ—¥æœ?        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // æ˜¾ç¤ºæ·»åŠ é»‘åå•æ¨¡æ€æ¡†
        function showAddBlacklistModal() {
            document.getElementById('addBlacklistModal').style.display = 'flex';
        }

        // éšè—æ·»åŠ é»‘åå•æ¨¡æ€æ¡†
        function hideAddBlacklistModal() {
            document.getElementById('addBlacklistModal').style.display = 'none';
            document.getElementById('blacklistIp').value = '';
            document.getElementById('blacklistName').value = '';
        }

        // æ·»åŠ é»‘åå?        async function addBlacklist() {
            const ip = document.getElementById('blacklistIp').value;
            const name = document.getElementById('blacklistName').value;

            if (!ip) {
                showToast('è¯·å¡«å†?IP åœ°å€', 'warning');
                return;
            }

            try {
                const data = await openwrtApi.post('/blacklist', {
                    ip: ip,
                    name: name || 'Blocked Device'
                });

                if (data.status === 'success') {
                    showToast('é»‘åå•æ·»åŠ æˆåŠ?, 'success');
                    hideAddBlacklistModal();
                    loadBlacklist();
                } else {
                    showToast('æ·»åŠ å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ é»‘åå•å¤±è´?', error);
                showToast('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // ç§»é™¤é»‘åå?        async function removeBlacklist(id) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤é»‘åå•å—ï¼?)) {
                return;
            }

            try {
                const data = await openwrtApi.delete(`/blacklist/${id}`);

                if (data.status === 'success') {
                    showToast('ç§»é™¤æˆåŠŸ', 'success');
                    loadBlacklist();
                } else {
                    showToast('ç§»é™¤å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤é»‘åå•å¤±è´?', error);
                showToast('ç§»é™¤å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : type === 'warning' ? '#faad14' : '#1890ff'};
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
