<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络设备管理 - Nexus</title>
    <link rel="stylesheet" href="../../css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <link rel="stylesheet" href="/console/css/dashboard.css">
    <script src="/console/js/theme-manager.js"></script>
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
        <!-- 头部 -->
        <div class="header">
            <h1><i class="ri-list-check"></i> 设备资产</h1>
            <div class="header-actions">
                <button class="btn btn-secondary theme-toggle-btn">
                    <i class="ri-sun-line"></i> 浅色模式
                </button>
                <button class="btn btn-primary" onclick="addDevice()">
                    <i class="ri-add-line"></i> 添加设备
                </button>
            </div>
        </div>
        
        <!-- 搜索和过滤 -->
        <div class="search-filter">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="搜索设备名称、IP、MAC..." id="searchInput">
                <button class="btn btn-secondary" onclick="searchDevices()">
                    <i class="ri-search-line"></i> 搜索
                </button>
            </div>
            <div>
                <select class="filter-select" id="statusFilter">
                    <option value="all">所有状态</option>
                    <option value="online">在线</option>
                    <option value="offline">离线</option>
                    <option value="warning">警告</option>
                </select>
                <select class="filter-select" id="typeFilter">
                    <option value="all">所有类型</option>
                    <option value="router">路由器</option>
                    <option value="switch">交换机</option>
                    <option value="pc">电脑</option>
                    <option value="printer">打印机</option>
                    <option value="nas">NAS</option>
                    <option value="other">其他</option>
                </select>
            </div>
        </div>
        
        <!-- 设备表格 -->
        <div class="card">
            <div class="table-container">
                <table id="deviceTable">
                    <thead>
                        <tr>
                            <th>设备名称</th>
                            <th>类型</th>
                            <th>IP地址</th>
                            <th>MAC地址</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <!-- 设备数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="pagination">
                <button class="page-btn" onclick="changePage(1)">首页</button>
                <button class="page-btn" onclick="changePage(currentPage - 1)">上一页</button>
                <button class="page-btn active" id="page1">1</button>
                <button class="page-btn" id="page2">2</button>
                <button class="page-btn" id="page3">3</button>
                <button class="page-btn" onclick="changePage(currentPage + 1)">下一页</button>
                <button class="page-btn" onclick="changePage(3)">末页</button>
            </div>
        </div>
    
    <script>
        // 获取设备图标
        function getDeviceIcon(type) {
            const iconMap = {
                router: 'router-wireless-line',
                switch: 'exchange-line',
                pc: 'computer-line',
                printer: 'printer-line',
                nas: 'hard-drive-line',
                other: 'device-line',
                light: 'lightbulb-line',
                socket: 'plug-line',
                lock: 'lock-line',
                sensor: 'thermometer-line'
            };
            return iconMap[type] || 'device-line';
        }
        
        // 获取设备类型名称
        function getDeviceTypeName(type) {
            const typeMap = {
                router: '路由器',
                switch: '交换机',
                pc: '电脑',
                printer: '打印机',
                nas: 'NAS',
                other: '其他',
                light: '智能灯泡',
                socket: '智能插座',
                lock: '智能门锁',
                sensor: '传感器'
            };
            return typeMap[type] || '其他';
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                online: '在线',
                offline: '离线',
                warning: '警告'
            };
            return statusMap[status] || '未知';
        }
        
        // 更新分页
        function updatePagination() {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            
            // 隐藏/显示分页按钮
            for (let i = 1; i <= 3; i++) {
                const pageBtn = document.getElementById(`page${i}`);
                if (pageBtn) {
                    if (i <= totalPages) {
                        pageBtn.style.display = 'inline-block';
                        pageBtn.textContent = i;
                        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                    } else {
                        pageBtn.style.display = 'none';
                    }
                }
            }
        }
        
        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderDevices();
            }
        }
        
        // 添加设备
        function addDevice() {
            alert('添加设备功能开发中...');
        }
        
        // 查看设备
        function viewDevice(id) {
            window.location.href = `device-details.html?id=${id}`;
        }
        
        // 编辑设备
        function editDevice(id) {
            alert(`编辑设备 ID: ${id}`);
        }
        
        // 删除设备
        async function deleteDevice(id) {
            if (confirm('确定要删除此设备吗？')) {
                try {
                    await SdkDataService.delete(COLLECTION_DEVICES, id);
                    await loadDevicesFromSdk();
                } catch (error) {
                    console.error('删除设备失败:', error);
                    showError('删除设备失败');
                }
            }
        }
        
        // 主题切换由 theme-manager.js 统一处理
    </script>
    
    <!-- SDK数据服务 -->
    <script src="/console/js/sdk-data-service.js"></script>
    <!-- 统一菜单加载脚本 -->
    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
    <script>
        // 集合名称
        const COLLECTION_DEVICES = 'devices';
        
        // 页面状态
        let currentPage = 1;
        const pageSize = 10;
        let filteredDevices = [];
        
        // 默认设备数据（首次初始化时使用）
        const defaultDevices = [
            { id: 'device-001', name: '智能灯泡', type: 'light', ip: '192.168.1.101', mac: 'AA:BB:CC:DD:EE:01', status: 'online', description: '客厅智能灯泡' },
            { id: 'device-002', name: '智能插座', type: 'socket', ip: '192.168.1.102', mac: 'AA:BB:CC:DD:EE:02', status: 'online', description: '卧室智能插座' },
            { id: 'device-003', name: '智能门锁', type: 'lock', ip: '192.168.1.103', mac: 'AA:BB:CC:DD:EE:03', status: 'offline', description: '前门智能门锁' },
            { id: 'device-004', name: '温湿度传感器', type: 'sensor', ip: '192.168.1.104', mac: 'AA:BB:CC:DD:EE:04', status: 'online', description: '室内温湿度传感器' }
        ];
        
        // 初始化页面
        async function init() {
            // 初始化默认数据（如果集合为空）
            await SdkDataService.initCollection(COLLECTION_DEVICES, defaultDevices);
            // 加载设备数据
            await loadDevicesFromSdk();
        }
        
        // 从SDK存储加载设备数据
        async function loadDevicesFromSdk() {
            try {
                const tableBody = document.getElementById('deviceTableBody');
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><i class="ri-loader-4-line ri-spin"></i> 加载中...</td></tr>';
                
                // 从SDK存储获取所有设备数据
                const devices = await SdkDataService.getAll(COLLECTION_DEVICES);
                
                // 转换数据格式
                const allDevices = devices.map(device => ({
                    id: device.id,
                    name: device.name,
                    type: device.type,
                    ip: device.ip || 'N/A',
                    mac: device.mac || 'N/A',
                    status: device.status,
                    description: device.description || ''
                }));
                
                filteredDevices = [...allDevices];
                renderDevices();
                
            } catch (error) {
                console.error('加载设备数据失败:', error);
                showError('加载设备数据失败，请检查网络连接');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const tableBody = document.getElementById('deviceTableBody');
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--nexus-danger);"><i class="ri-error-warning-line"></i> ${message}</td></tr>`;
        }
        
        // 渲染设备列表
        function renderDevices() {
            const tableBody = document.getElementById('deviceTableBody');
            tableBody.innerHTML = '';
            
            if (filteredDevices.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">暂无设备数据</td></tr>';
                updatePagination();
                return;
            }
            
            // 计算分页数据
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageDevices = filteredDevices.slice(startIndex, endIndex);
            
            pageDevices.forEach(device => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <i class="ri-${getDeviceIcon(device.type)} device-icon"></i>
                        ${device.name}
                    </td>
                    <td>${getDeviceTypeName(device.type)}</td>
                    <td>${device.ip}</td>
                    <td>${device.mac}</td>
                    <td>
                        <span class="status-indicator status-${device.status}"></span>
                        ${getStatusText(device.status)}
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewDevice('${device.id}')"><i class="ri-eye-line"></i></button>
                        <button class="btn btn-primary" onclick="editDevice('${device.id}')"><i class="ri-edit-line"></i></button>
                        <button class="btn btn-danger" onclick="deleteDevice('${device.id}')"><i class="ri-delete-line"></i></button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 更新分页按钮
            updatePagination();
        }
        
        // 搜索设备
        async function searchDevices() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            try {
                let devices;
                
                // 构建查询条件
                const conditions = {};
                if (statusFilter !== 'all') {
                    conditions.status = statusFilter;
                }
                if (typeFilter !== 'all') {
                    conditions.type = typeFilter;
                }
                
                // 如果有过滤条件，使用查询接口
                if (Object.keys(conditions).length > 0) {
                    devices = await SdkDataService.query(COLLECTION_DEVICES, conditions);
                } else {
                    devices = await SdkDataService.getAll(COLLECTION_DEVICES);
                }
                
                // 转换数据格式并进行本地搜索过滤
                filteredDevices = devices.map(device => ({
                    id: device.id,
                    name: device.name,
                    type: device.type,
                    ip: device.ip || 'N/A',
                    mac: device.mac || 'N/A',
                    status: device.status,
                    description: device.description || ''
                })).filter(device => {
                    if (!searchTerm) return true;
                    return device.name.toLowerCase().includes(searchTerm) || 
                           device.ip.toLowerCase().includes(searchTerm) ||
                           device.mac.toLowerCase().includes(searchTerm) ||
                           device.description.toLowerCase().includes(searchTerm);
                });
                
                currentPage = 1;
                renderDevices();
            } catch (error) {
                console.error('搜索设备失败:', error);
                showError('搜索设备失败');
            }
        }
        
        // 初始化菜单和页面
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // 绑定搜索事件
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchDevices();
                }
            });
            
            document.getElementById('statusFilter').addEventListener('change', searchDevices);
            document.getElementById('typeFilter').addEventListener('change', searchDevices);
        });
    </script>
    </div>
</body>
</html>