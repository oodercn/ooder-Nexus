<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt è·¯ç”±å™¨ç®¡ç?- Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">`n    <link rel="stylesheet" href="/console/css/theme.css">`n    <link rel="stylesheet" href="/console/css/dashboard.css">`n    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/theme-manager.js"></script>`n    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹å¯¼èˆªæ ?-->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1><i class="ri-router-line"></i> OpenWrt è·¯ç”±å™¨ç®¡ç?/h1>
                <div class="header-actions">
                    <button id="mockToggleBtn" class="btn btn-secondary" onclick="toggleMockMode()">
                        <i class="ri-bug-line"></i> æ¨¡æ‹Ÿæ¨¡å¼
                    </button>
                    <button class="theme-toggle-btn btn btn-secondary">
                        <i class="ri-sun-line"></i> æµ…è‰²æ¨¡å¼
                    </button>
                    <button id="refresh-btn" class="btn btn-primary" onclick="refreshData()">
                        <i class="ri-refresh-line"></i> åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
            
            <!-- è¿æ¥çŠ¶æ€å¡ç‰?-->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-router-line"></i> è·¯ç”±å™¨è¿æ¥çŠ¶æ€?/h2>
                    <span id="connectionStatus" class="status-badge status-offline">æœªè¿æ?/span>
                </div>
                <div id="routerInfo" style="display: none;">
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 15px;">
                        <div class="info-item">
                            <span class="info-label">è®¾å¤‡åœ°å€</span>
                            <span id="routerHost" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å›ºä»¶ç‰ˆæœ¬</span>
                            <span id="firmwareVersion" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¿è¡Œæ—¶é—´</span>
                            <span id="uptime" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è®¾å¤‡å‹å·</span>
                            <span id="deviceModel" class="info-value">-</span>
                        </div>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="connectBtn" class="btn btn-primary" onclick="showConnectModal()">
                        <i class="ri-link"></i> è¿æ¥è·¯ç”±å™?                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnectRouter()" style="display: none;">
                        <i class="ri-unlink"></i> æ–­å¼€è¿æ¥
                    </button>
                    <button id="rebootBtn" class="btn btn-warning" onclick="rebootRouter()" style="display: none;">
                        <i class="ri-restart-line"></i> é‡å¯è·¯ç”±å™?                    </button>
                </div>
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            <h3 style="margin: 30px 0 15px; color: var(--nexus-text);">å¿«æ·æ“ä½œ</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="card status-card" onclick="navigateTo('network-settings')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="ri-wifi-settings-line"></i>
                    </div>
                    <div class="status-value">ç½‘ç»œè®¾ç½®</div>
                    <div class="status-label">é…ç½®ç½‘ç»œå‚æ•°</div>
                </div>
                <div class="card status-card" onclick="navigateTo('ip-management')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="ri-ip-line"></i>
                    </div>
                    <div class="status-value">IP ç®¡ç†</div>
                    <div class="status-label">ç®¡ç† IP åœ°å€</div>
                </div>
                <div class="card status-card" onclick="navigateTo('blacklist')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="ri-shield-cross-line"></i>
                    </div>
                    <div class="status-value">é»‘åå?/div>
                    <div class="status-label">ç®¡ç†è®¿é—®æ§åˆ¶</div>
                </div>
                <div class="card status-card" onclick="navigateTo('config-files')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="ri-file-settings-line"></i>
                    </div>
                    <div class="status-value">é…ç½®æ–‡ä»¶</div>
                    <div class="status-label">ç¼–è¾‘é…ç½®æ–‡ä»¶</div>
                </div>
                <div class="card status-card" onclick="navigateTo('system-status')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="ri-dashboard-line"></i>
                    </div>
                    <div class="status-value">ç³»ç»ŸçŠ¶æ€?/div>
                    <div class="status-label">æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</div>
                </div>
                <div class="card status-card" onclick="navigateTo('command')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="ri-terminal-line"></i>
                    </div>
                    <div class="status-value">å‘½ä»¤æ‰§è¡Œ</div>
                    <div class="status-label">æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿æ¥æ¨¡æ€æ¡† -->
    <div id="connectModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">è¿æ¥ OpenWrt è·¯ç”±å™?/h3>
                <button class="modal-close" onclick="hideConnectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è·¯ç”±å™¨åœ°å€</label>
                    <input type="text" id="hostInput" class="form-input" placeholder="192.168.1.1" value="192.168.1.1">
                </div>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å?/label>
                    <input type="text" id="usernameInput" class="form-input" placeholder="root" value="root">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="å¯†ç ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideConnectModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="connectRouter()">è¿æ¥</button>
            </div>
        </div>
    </div>

    <script>
        // OpenWrt API å°è£…
        const openwrtApi = {
            baseUrl: '/api/openwrt',
            async get(endpoint) {
                const response = await fetch(`${this.baseUrl}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            },
            async post(endpoint, data = {}) {
                const response = await fetch(`${this.baseUrl}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            }
        };

        // é¡µé¢è‡ªå®šä¹‰åˆå§‹åŒ–
        window.onPageInit = function() {
            checkConnectionStatus();
            checkMockStatus();
        };

        // æ£€æŸ¥è¿æ¥çŠ¶æ€?        async function checkConnectionStatus() {
            try {
                const data = await openwrtApi.get('/status');
                if (data.connected) {
                    updateConnectionUI(true);
                    loadSystemStatus();
                } else {
                    updateConnectionUI(false);
                }
            } catch (error) {
                console.error('æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´?', error);
                updateConnectionUI(false);
            }
        }

        // æ£€æŸ?Mock çŠ¶æ€?        async function checkMockStatus() {
            try {
                const data = await openwrtApi.get('/mock/status');
                updateMockStatusUI(data.mockEnabled);
            } catch (error) {
                console.error('æ£€æŸ?Mock çŠ¶æ€å¤±è´?', error);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€?UI
        function updateConnectionUI(connected) {
            const statusBadge = document.getElementById('connectionStatus');
            const routerInfo = document.getElementById('routerInfo');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const rebootBtn = document.getElementById('rebootBtn');

            if (connected) {
                statusBadge.textContent = 'å·²è¿æ?;
                statusBadge.className = 'status-badge status-online';
                routerInfo.style.display = 'block';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-flex';
                rebootBtn.style.display = 'inline-flex';
            } else {
                statusBadge.textContent = 'æœªè¿æ?;
                statusBadge.className = 'status-badge status-offline';
                routerInfo.style.display = 'none';
                connectBtn.style.display = 'inline-flex';
                disconnectBtn.style.display = 'none';
                rebootBtn.style.display = 'none';
            }
        }

        // æ›´æ–° Mock çŠ¶æ€?UI
        function updateMockStatusUI(enabled) {
            const statusBadge = document.getElementById('connectionStatus');
            const mockBtn = document.getElementById('mockToggleBtn');

            if (enabled) {
                mockBtn.innerHTML = '<i class="ri-bug-line"></i> æ¨¡æ‹Ÿæ¨¡å¼ (å¼€)';
                mockBtn.style.background = '#fa8c16';
                mockBtn.style.color = 'white';
                if (statusBadge.textContent === 'æœªè¿æ?) {
                    statusBadge.textContent = 'æ¨¡æ‹Ÿæ¨¡å¼';
                    statusBadge.className = 'status-badge';
                    statusBadge.style.background = '#fff7e6';
                    statusBadge.style.color = '#fa8c16';
                }
            } else {
                mockBtn.innerHTML = '<i class="ri-bug-line"></i> æ¨¡æ‹Ÿæ¨¡å¼';
                mockBtn.style.background = '';
                mockBtn.style.color = '';
            }
        }

        // æ˜¾ç¤ºè¿æ¥æ¨¡æ€æ¡†
        function showConnectModal() {
            document.getElementById('connectModal').style.display = 'flex';
        }

        // éšè—è¿æ¥æ¨¡æ€æ¡†
        function hideConnectModal() {
            document.getElementById('connectModal').style.display = 'none';
        }

        // è¿æ¥è·¯ç”±å™?        async function connectRouter() {
            const host = document.getElementById('hostInput').value;
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;

            try {
                const data = await openwrtApi.post('/connect', { host, username, password });

                if (data.connected) {
                    hideConnectModal();
                    updateConnectionUI(true);
                    loadSystemStatus();
                    showToast('è¿æ¥æˆåŠŸ', 'success');
                } else {
                    showToast('è¿æ¥å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('è¿æ¥è·¯ç”±å™¨å¤±è´?', error);
                showToast('è¿æ¥å¤±è´¥', 'error');
            }
        }

        // æ–­å¼€è¿æ¥
        async function disconnectRouter() {
            try {
                await openwrtApi.post('/disconnect');
                updateConnectionUI(false);
                showToast('å·²æ–­å¼€è¿æ¥', 'success');
            } catch (error) {
                console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error);
                showToast('æ–­å¼€è¿æ¥å¤±è´¥', 'error');
            }
        }

        // é‡å¯è·¯ç”±å™?        async function rebootRouter() {
            if (!confirm('ç¡®å®šè¦é‡å¯è·¯ç”±å™¨å—ï¼Ÿè¿™å°†å¯¼è‡´çŸ­æš‚æ–­ç½‘ã€?)) {
                return;
            }

            try {
                const data = await openwrtApi.post('/reboot');

                if (data.status === 'success') {
                    showToast('é‡å¯å‘½ä»¤å·²å‘é€ï¼Œè¯·ç­‰å¾…è·¯ç”±å™¨é‡å¯', 'success');
                    setTimeout(() => {
                        updateConnectionUI(false);
                    }, 5000);
                } else {
                    showToast('é‡å¯å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('é‡å¯è·¯ç”±å™¨å¤±è´?', error);
                showToast('é‡å¯å¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢ Mock æ¨¡å¼
        async function toggleMockMode() {
            try {
                const statusData = await openwrtApi.get('/mock/status');
                const newMode = !statusData.mockEnabled;
                const endpoint = newMode ? '/mock/enable' : '/mock/disable';

                const data = await openwrtApi.post(endpoint);

                if (data.status === 'success') {
                    updateMockStatusUI(newMode);
                    showToast(newMode ? 'å·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°çœŸå®æ¨¡å¼', 'success');
                    checkConnectionStatus();
                }
            } catch (error) {
                console.error('åˆ‡æ¢ Mock æ¨¡å¼å¤±è´¥:', error);
                showToast('åˆ‡æ¢å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€?        async function loadSystemStatus() {
            try {
                const data = await openwrtApi.get('/system-status');

                if (data.status === 'success' && data.data) {
                    const status = data.data;
                    document.getElementById('firmwareVersion').textContent = status.firmwareVersion || '-';
                    document.getElementById('uptime').textContent = status.uptime || '-';
                    document.getElementById('deviceModel').textContent = status.deviceModel || '-';
                }

                // è·å–ç‰ˆæœ¬ä¿¡æ¯
                const versionData = await openwrtApi.get('/version');

                if (versionData.status === 'success' && versionData.data) {
                    document.getElementById('routerHost').textContent = versionData.data.deviceInfo || '-';
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´?', error);
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            checkConnectionStatus();
            if (document.getElementById('connectionStatus').textContent === 'å·²è¿æ?) {
                loadSystemStatus();
            }
            showToast('æ•°æ®å·²åˆ·æ–?, 'success');
        }

        // é¡µé¢å¯¼èˆª
        function navigateTo(page) {
            const pages = {
                'network-settings': 'network-settings.html',
                'ip-management': 'ip-management.html',
                'blacklist': 'blacklist.html',
                'config-files': 'config-files.html',
                'system-status': 'system-status.html',
                'command': 'command.html'
            };

            if (pages[page]) {
                window.location.href = pages[page];
            }
        }

        // ä¸»é¢˜åˆ‡æ¢ç”?theme-manager.js ç»Ÿä¸€å¤„ç†ï¼Œä½¿ç”?window.toggleTheme() è°ƒç”¨

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            if (typeof showMessage === 'function') {
                showMessage(message, type);
            } else {
                // ç®€å•çš„ toast å®ç°
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 24px;
                    border-radius: 4px;
                    color: white;
                    font-size: 14px;
                    z-index: 9999;
                    animation: slideIn 0.3s ease-out;
                    background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : '#1890ff'};
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
        }
    </script>
</body>
</html>
