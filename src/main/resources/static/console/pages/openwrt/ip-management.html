<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP åœ°å€ç®¡ç† - OpenWrt - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">`n    <link rel="stylesheet" href="/console/css/theme.css">`n    <link rel="stylesheet" href="/console/css/dashboard.css">`n    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/theme-manager.js"></script>`n    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹å¯¼èˆªæ ?-->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1><i class="ri-ip-line"></i> IP åœ°å€ç®¡ç†</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="history.back()">
                        <i class="ri-arrow-left-line"></i> è¿”å›
                    </button>
                    <button class="btn btn-primary" onclick="showAddIPModal()">
                        <i class="ri-add-line"></i> æ·»åŠ é™æ€?IP
                    </button>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="ri-computer-line"></i>
                    </div>
                    <div class="status-value" id="totalDevices">0</div>
                    <div class="status-label">æ€»è®¾å¤‡æ•°</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="ri-wifi-line"></i>
                    </div>
                    <div class="status-value" id="onlineDevices">0</div>
                    <div class="status-label">åœ¨çº¿è®¾å¤‡</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="ri-lock-line"></i>
                    </div>
                    <div class="status-value" id="staticIPs">0</div>
                    <div class="status-label">é™æ€?IP</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="ri-exchange-line"></i>
                    </div>
                    <div class="status-value" id="dynamicIPs">0</div>
                    <div class="status-label">åŠ¨æ€?IP</div>
                </div>
            </div>
            
            <!-- IP åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-list-check"></i> IP åœ°å€åˆ—è¡¨</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="filterType" class="form-input" style="width: 120px;" onchange="loadIPAddresses()">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="static">é™æ€?IP</option>
                            <option value="dynamic">åŠ¨æ€?IP</option>
                        </select>
                        <select id="filterStatus" class="form-input" style="width: 120px;" onchange="loadIPAddresses()">
                            <option value="">å…¨éƒ¨çŠ¶æ€?/option>
                            <option value="online">åœ¨çº¿</option>
                            <option value="offline">ç¦»çº¿</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadIPAddresses()">
                            <i class="ri-refresh-line"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="ipTable">
                            <thead>
                                <tr>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>IP åœ°å€</th>
                                    <th>MAC åœ°å€</th>
                                    <th>ç±»å‹</th>
                                    <th>çŠ¶æ€?/th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="ipTableBody">
                                <!-- åŠ¨æ€ç”Ÿæˆ?-->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é™æ€?IP æ¨¡æ€æ¡† -->
    <div id="addIPModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ é™æ€?IP</h3>
                <button class="modal-close" onclick="hideAddIPModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è®¾å¤‡åç§°</label>
                    <input type="text" id="deviceName" class="form-input" placeholder="ä¾‹å¦‚ï¼šå®¢å…ç”µè§?>
                </div>
                <div class="form-group">
                    <label class="form-label">IP åœ°å€</label>
                    <input type="text" id="ipAddress" class="form-input" placeholder="192.168.1.50">
                </div>
                <div class="form-group">
                    <label class="form-label">MAC åœ°å€</label>
                    <input type="text" id="macAddress" class="form-input" placeholder="AA:BB:CC:DD:EE:FF">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddIPModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addStaticIP()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script src="/console/common/api-client.js"></script>
    <script src="/console/common/button-manager.js"></script>
    <script src="/console/common/utils.js"></script>
    <script>
        // API å®¢æˆ·ç«¯å®ä¾?        const openwrtApi = new ApiClient('/api/openwrt');

        // é¡µé¢åˆå§‹åŒ?        window.onPageInit = function() {
            loadIPAddresses();
        };

        // åŠ è½½ IP åœ°å€åˆ—è¡¨
        async function loadIPAddresses() {
            try {
                const type = document.getElementById('filterType').value;
                const status = document.getElementById('filterStatus').value;
                
                const params = {};
                if (type) params.type = type;
                if (status) params.status = status;

                const data = await openwrtApi.get('/ip-addresses', params);

                if (data.status === 'success') {
                    renderIPTable(data.data || []);
                    updateStats(data.stats || {});
                }
            } catch (error) {
                console.error('åŠ è½½ IP åœ°å€å¤±è´¥:', error);
                showToast('åŠ è½½ IP åœ°å€å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ IP è¡¨æ ¼
        function renderIPTable(ipList) {
            const tbody = document.getElementById('ipTableBody');
            tbody.innerHTML = '';

            if (!ipList || ipList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            ipList.forEach(ip => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ip.name || '-'}</td>
                    <td>${ip.ip || '-'}</td>
                    <td>${ip.mac || '-'}</td>
                    <td>
                        <span class="badge ${ip.type === 'static' ? 'badge-primary' : 'badge-secondary'}">
                            ${ip.type === 'static' ? 'é™æ€? : 'åŠ¨æ€?}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${ip.status === 'online' ? 'badge-success' : 'badge-warning'}">
                            ${ip.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </span>
                    </td>
                    <td>
                        ${ip.type === 'static' ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteIP('${ip.id}')">
                                <i class="ri-delete-bin-line"></i> åˆ é™¤
                            </button>
                        ` : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats(stats) {
            document.getElementById('totalDevices').textContent = stats.total || 0;
            document.getElementById('onlineDevices').textContent = stats.online || 0;
            document.getElementById('staticIPs').textContent = stats.static || 0;
            document.getElementById('dynamicIPs').textContent = stats.dynamic || 0;
        }

        // æ˜¾ç¤ºæ·»åŠ  IP æ¨¡æ€æ¡†
        function showAddIPModal() {
            document.getElementById('addIPModal').style.display = 'flex';
        }

        // éšè—æ·»åŠ  IP æ¨¡æ€æ¡†
        function hideAddIPModal() {
            document.getElementById('addIPModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('deviceName').value = '';
            document.getElementById('ipAddress').value = '';
            document.getElementById('macAddress').value = '';
        }

        // æ·»åŠ é™æ€?IP
        async function addStaticIP() {
            const name = document.getElementById('deviceName').value;
            const ip = document.getElementById('ipAddress').value;
            const mac = document.getElementById('macAddress').value;

            if (!name || !ip || !mac) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ?, 'warning');
                return;
            }

            try {
                const data = await openwrtApi.post('/ip-addresses', {
                    name: name,
                    ip: ip,
                    mac: mac
                });

                if (data.status === 'success') {
                    showToast('é™æ€?IP æ·»åŠ æˆåŠŸ', 'success');
                    hideAddIPModal();
                    loadIPAddresses();
                } else {
                    showToast('æ·»åŠ å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ é™æ€?IP å¤±è´¥:', error);
                showToast('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ IP
        async function deleteIP(ipId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é™æ€?IP å—ï¼Ÿ')) {
                return;
            }

            try {
                const data = await openwrtApi.delete(`/ip-addresses/${ipId}`);

                if (data.status === 'success') {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadIPAddresses();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ IP å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : type === 'warning' ? '#faad14' : '#1890ff'};
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
