<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP 地址管理 - OpenWrt - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="ri-ip-line"></i> IP 地址管理</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="history.back()">
                        <i class="ri-arrow-left-line"></i> 返回
                    </button>
                    <button class="btn btn-primary" onclick="showAddIPModal()">
                        <i class="ri-add-line"></i> 添加静态 IP
                    </button>
                </div>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="ri-computer-line"></i>
                    </div>
                    <div class="status-value" id="totalDevices">0</div>
                    <div class="status-label">总设备数</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="ri-wifi-line"></i>
                    </div>
                    <div class="status-value" id="onlineDevices">0</div>
                    <div class="status-label">在线设备</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="ri-lock-line"></i>
                    </div>
                    <div class="status-value" id="staticIPs">0</div>
                    <div class="status-label">静态 IP</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="ri-exchange-line"></i>
                    </div>
                    <div class="status-value" id="dynamicIPs">0</div>
                    <div class="status-label">动态 IP</div>
                </div>
            </div>
            
            <!-- IP 列表 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-list-check"></i> IP 地址列表</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="filterType" class="form-input" style="width: 120px;" onchange="loadIPAddresses()">
                            <option value="">全部类型</option>
                            <option value="static">静态 IP</option>
                            <option value="dynamic">动态 IP</option>
                        </select>
                        <select id="filterStatus" class="form-input" style="width: 120px;" onchange="loadIPAddresses()">
                            <option value="">全部状态</option>
                            <option value="online">在线</option>
                            <option value="offline">离线</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadIPAddresses()">
                            <i class="ri-refresh-line"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="ipTable">
                            <thead>
                                <tr>
                                    <th>设备名称</th>
                                    <th>IP 地址</th>
                                    <th>MAC 地址</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ipTableBody">
                                <!-- 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加静态 IP 模态框 -->
    <div id="addIPModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">添加静态 IP</h3>
                <button class="modal-close" onclick="hideAddIPModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">设备名称</label>
                    <input type="text" id="deviceName" class="form-input" placeholder="例如：客厅电视">
                </div>
                <div class="form-group">
                    <label class="form-label">IP 地址</label>
                    <input type="text" id="ipAddress" class="form-input" placeholder="192.168.1.50">
                </div>
                <div class="form-group">
                    <label class="form-label">MAC 地址</label>
                    <input type="text" id="macAddress" class="form-input" placeholder="AA:BB:CC:DD:EE:FF">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddIPModal()">取消</button>
                <button class="btn btn-primary" onclick="addStaticIP()">添加</button>
            </div>
        </div>
    </div>

    <script src="/console/common/api-client.js"></script>
    <script src="/console/common/button-manager.js"></script>
    <script src="/console/common/utils.js"></script>
    <script>
        // API 客户端实例
        const openwrtApi = new ApiClient('/api/openwrt');

        // 页面初始化
        window.onPageInit = function() {
            loadIPAddresses();
        };

        // 加载 IP 地址列表
        async function loadIPAddresses() {
            try {
                const type = document.getElementById('filterType').value;
                const status = document.getElementById('filterStatus').value;
                
                const params = {};
                if (type) params.type = type;
                if (status) params.status = status;

                const data = await openwrtApi.get('/ip-addresses', params);

                if (data.status === 'success') {
                    renderIPTable(data.data || []);
                    updateStats(data.stats || {});
                }
            } catch (error) {
                console.error('加载 IP 地址失败:', error);
                showToast('加载 IP 地址失败', 'error');
            }
        }

        // 渲染 IP 表格
        function renderIPTable(ipList) {
            const tbody = document.getElementById('ipTableBody');
            tbody.innerHTML = '';

            if (!ipList || ipList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">暂无数据</td></tr>';
                return;
            }

            ipList.forEach(ip => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ip.name || '-'}</td>
                    <td>${ip.ip || '-'}</td>
                    <td>${ip.mac || '-'}</td>
                    <td>
                        <span class="badge ${ip.type === 'static' ? 'badge-primary' : 'badge-secondary'}">
                            ${ip.type === 'static' ? '静态' : '动态'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${ip.status === 'online' ? 'badge-success' : 'badge-warning'}">
                            ${ip.status === 'online' ? '在线' : '离线'}
                        </span>
                    </td>
                    <td>
                        ${ip.type === 'static' ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteIP('${ip.id}')">
                                <i class="ri-delete-bin-line"></i> 删除
                            </button>
                        ` : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 更新统计
        function updateStats(stats) {
            document.getElementById('totalDevices').textContent = stats.total || 0;
            document.getElementById('onlineDevices').textContent = stats.online || 0;
            document.getElementById('staticIPs').textContent = stats.static || 0;
            document.getElementById('dynamicIPs').textContent = stats.dynamic || 0;
        }

        // 显示添加 IP 模态框
        function showAddIPModal() {
            document.getElementById('addIPModal').style.display = 'flex';
        }

        // 隐藏添加 IP 模态框
        function hideAddIPModal() {
            document.getElementById('addIPModal').style.display = 'none';
            // 清空表单
            document.getElementById('deviceName').value = '';
            document.getElementById('ipAddress').value = '';
            document.getElementById('macAddress').value = '';
        }

        // 添加静态 IP
        async function addStaticIP() {
            const name = document.getElementById('deviceName').value;
            const ip = document.getElementById('ipAddress').value;
            const mac = document.getElementById('macAddress').value;

            if (!name || !ip || !mac) {
                showToast('请填写完整信息', 'warning');
                return;
            }

            try {
                const data = await openwrtApi.post('/ip-addresses', {
                    name: name,
                    ip: ip,
                    mac: mac
                });

                if (data.status === 'success') {
                    showToast('静态 IP 添加成功', 'success');
                    hideAddIPModal();
                    loadIPAddresses();
                } else {
                    showToast('添加失败: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('添加静态 IP 失败:', error);
                showToast('添加失败', 'error');
            }
        }

        // 删除 IP
        async function deleteIP(ipId) {
            if (!confirm('确定要删除此静态 IP 吗？')) {
                return;
            }

            try {
                const data = await openwrtApi.delete(`/ip-addresses/${ipId}`);

                if (data.status === 'success') {
                    showToast('删除成功', 'success');
                    loadIPAddresses();
                } else {
                    showToast('删除失败: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('删除 IP 失败:', error);
                showToast('删除失败', 'error');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : type === 'warning' ? '#faad14' : '#1890ff'};
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
