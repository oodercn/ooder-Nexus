<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜å‚¨ç®¡ç† - Nexus SkillCenter</title>
    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">`n    <link rel="stylesheet" href="/console/css/theme.css">`n    <link rel="stylesheet" href="/console/css/dashboard.css">`n    <link rel="stylesheet" href="/console/css/styles.css">
    <script src="/console/js/theme-manager.js"></script>`n    <script src="/console/js/menu-loader.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        <main class="main-content">
            <header class="header">
                <h1>å­˜å‚¨ç®¡ç†</h1>
            </header>
            <div class="content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('status')">å­˜å‚¨çŠ¶æ€?/button>
                    <button class="tab-btn" onclick="switchTab('backup')">å­˜å‚¨å¤‡ä»½</button>
                    <button class="tab-btn" onclick="switchTab('restore')">å­˜å‚¨æ¢å¤</button>
                    <button class="tab-btn" onclick="switchTab('clean')">å­˜å‚¨æ¸…ç†</button>
                    <button class="tab-btn" onclick="switchTab('settings')">å­˜å‚¨è®¾ç½®</button>
                </div>
                
                <div class="tab-content" id="status-tab">
                    <div class="storage-status" id="storage-status">
                        <div class="loading">åŠ è½½ä¸?..</div>
                    </div>
                </div>
                
                <div class="tab-content" id="backup-tab" style="display: none;">
                    <div class="backup-list" id="backup-list">
                        <div class="loading">åŠ è½½ä¸?..</div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="ri-save-line"></i> åˆ›å»ºå¤‡ä»½
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="restore-tab" style="display: none;">
                    <div class="restore-list" id="restore-list">
                        <div class="loading">åŠ è½½ä¸?..</div>
                    </div>
                </div>
                
                <div class="tab-content" id="clean-tab" style="display: none;">
                    <div class="clean-options">
                        <h3>æ¸…ç†é€‰é¡¹</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-temp"> æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-cache"> æ¸…ç†ç¼“å­˜
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-logs"> æ¸…ç†æ—¥å¿—æ–‡ä»¶
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clean-old-backups"> æ¸…ç†æ—§å¤‡ä»?                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="performClean()">
                            <i class="ri-delete-bin-line"></i> æ‰§è¡Œæ¸…ç†
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="settings-tab" style="display: none;">
                    <div class="storage-settings">
                        <h3>å­˜å‚¨è®¾ç½®</h3>
                        <form id="storage-settings-form">
                            <div class="form-group">
                                <label>å­˜å‚¨è·¯å¾„</label>
                                <input type="text" id="storage-path" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å­˜å‚¨ç©ºé—?(GB)</label>
                                <input type="number" id="max-storage" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>å¤‡ä»½ä¿ç•™å¤©æ•°</label>
                                <input type="number" id="backup-retention" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>è‡ªåŠ¨å¤‡ä»½</label>
                                <select id="auto-backup" class="form-control">
                                    <option value="disabled">ç¦ç”¨</option>
                                    <option value="daily">æ¯å¤©</option>
                                    <option value="weekly">æ¯å‘¨</option>
                                    <option value="monthly">æ¯æœˆ</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="ri-save-line"></i> ä¿å­˜è®¾ç½®
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.onload = function() {
            initMenu();
            loadStorageStatus();
            loadBackupList();
            loadRestoreList();
            loadSettings();
        };

        async function loadStorageStatus() {
            try {
                const response = await fetch('/api/admin/storage/status');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderStorageStatus(result.data);
                } else {
                    showError('åŠ è½½å­˜å‚¨çŠ¶æ€å¤±è´?);
                }
            } catch (error) {
                console.error('åŠ è½½å­˜å‚¨çŠ¶æ€é”™è¯?', error);
                showError('åŠ è½½å­˜å‚¨çŠ¶æ€å¤±è´?);
            }
        }

        function renderStorageStatus(status) {
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = `
                <div class="storage-overview">
                    <div class="storage-card">
                        <h4>æ€»ç©ºé—?/h4>
                        <p class="storage-value">${formatSize(status.totalSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>å·²ä½¿ç”?/h4>
                        <p class="storage-value">${formatSize(status.usedSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>å¯ç”¨ç©ºé—´</h4>
                        <p class="storage-value">${formatSize(status.freeSpace)}</p>
                    </div>
                    <div class="storage-card">
                        <h4>ä½¿ç”¨ç?/h4>
                        <p class="storage-value">${status.usagePercent}%</p>
                    </div>
                </div>
                <div class="storage-details">
                    <h4>å­˜å‚¨è¯¦æƒ…</h4>
                    <ul>
                        <li><strong>æŠ€èƒ½æ–‡ä»?</strong> ${formatSize(status.skillFiles)}</li>
                        <li><strong>å¤‡ä»½æ–‡ä»¶:</strong> ${formatSize(status.backupFiles)}</li>
                        <li><strong>æ—¥å¿—æ–‡ä»¶:</strong> ${formatSize(status.logFiles)}</li>
                        <li><strong>ä¸´æ—¶æ–‡ä»¶:</strong> ${formatSize(status.tempFiles)}</li>
                        <li><strong>å…¶ä»–æ–‡ä»¶:</strong> ${formatSize(status.otherFiles)}</li>
                    </ul>
                </div>
            `;
        }

        async function loadBackupList() {
            try {
                const response = await fetch('/api/admin/storage/backups');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderBackupList(result.data);
                } else {
                    showError('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å¤‡ä»½åˆ—è¡¨é”™è¯¯:', error);
                showError('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥');
            }
        }

        function renderBackupList(backups) {
            const backupList = document.getElementById('backup-list');
            backupList.innerHTML = '';
            
            backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                backupItem.innerHTML = `
                    <div class="backup-info">
                        <h3>${backup.name}</h3>
                        <p><strong>å¤§å°:</strong> ${formatSize(backup.size)}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${formatTime(backup.createdAt)}</p>
                        <p><strong>æè¿°:</strong> ${backup.description || 'æ—?}</p>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-secondary" onclick="downloadBackup('${backup.id}')">
                            <i class="ri-download-line"></i> ä¸‹è½½
                        </button>
                        <button class="btn btn-primary" onclick="restoreFromBackup('${backup.id}')">
                            <i class="ri-refresh-line"></i> æ¢å¤
                        </button>
                        <button class="btn btn-danger" onclick="deleteBackup('${backup.id}')">
                            <i class="ri-delete-line"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                backupList.appendChild(backupItem);
            });
        }

        async function loadRestoreList() {
            try {
                const response = await fetch('/api/admin/storage/backups');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    renderRestoreList(result.data);
                } else {
                    showError('åŠ è½½æ¢å¤åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ¢å¤åˆ—è¡¨é”™è¯¯:', error);
                showError('åŠ è½½æ¢å¤åˆ—è¡¨å¤±è´¥');
            }
        }

        function renderRestoreList(backups) {
            const restoreList = document.getElementById('restore-list');
            restoreList.innerHTML = '';
            
            backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                backupItem.innerHTML = `
                    <div class="backup-info">
                        <h3>${backup.name}</h3>
                        <p><strong>å¤§å°:</strong> ${formatSize(backup.size)}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${formatTime(backup.createdAt)}</p>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-primary" onclick="restoreFromBackup('${backup.id}')">
                            <i class="ri-refresh-line"></i> æ¢å¤
                        </button>
                    </div>
                `;
                restoreList.appendChild(backupItem);
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/storage/settings');
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    const settings = result.data;
                    document.getElementById('storage-path').value = settings.storagePath || '';
                    document.getElementById('max-storage').value = settings.maxStorage || '';
                    document.getElementById('backup-retention').value = settings.backupRetention || '';
                    document.getElementById('auto-backup').value = settings.autoBackup || 'disabled';
                }
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®é”™è¯¯:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').style.display = 'block';
        }

        async function createBackup() {
            try {
                const response = await fetch('/api/admin/storage/backup', {
                    method: 'POST'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('å¤‡ä»½åˆ›å»ºæˆåŠŸ');
                    loadBackupList();
                    loadRestoreList();
                } else {
                    showError('å¤‡ä»½åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºå¤‡ä»½é”™è¯¯:', error);
                showError('å¤‡ä»½åˆ›å»ºå¤±è´¥');
            }
        }

        async function downloadBackup(backupId) {
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${backupId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    showError('ä¸‹è½½å¤‡ä»½å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸‹è½½å¤‡ä»½é”™è¯¯:', error);
                showError('ä¸‹è½½å¤‡ä»½å¤±è´¥');
            }
        }

        async function restoreFromBackup(backupId) {
            if (!confirm('ç¡®å®šè¦ä»æ­¤å¤‡ä»½æ¢å¤å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®ã€?)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}/restore`, {
                    method: 'POST'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('æ•°æ®æ¢å¤æˆåŠŸ');
                    loadStorageStatus();
                } else {
                    showError('æ•°æ®æ¢å¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¢å¤æ•°æ®é”™è¯¯:', error);
                showError('æ•°æ®æ¢å¤å¤±è´¥');
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/storage/backups/${backupId}`, {
                    method: 'DELETE'
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('å¤‡ä»½åˆ é™¤æˆåŠŸ');
                    loadBackupList();
                    loadRestoreList();
                } else {
                    showError('å¤‡ä»½åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤‡ä»½é”™è¯¯:', error);
                showError('å¤‡ä»½åˆ é™¤å¤±è´¥');
            }
        }

        async function performClean() {
            const cleanTemp = document.getElementById('clean-temp').checked;
            const cleanCache = document.getElementById('clean-cache').checked;
            const cleanLogs = document.getElementById('clean-logs').checked;
            const cleanOldBackups = document.getElementById('clean-old-backups').checked;
            
            if (!cleanTemp && !cleanCache && !cleanLogs && !cleanOldBackups) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¸…ç†é€‰é¡¹');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/storage/clean', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cleanTemp: cleanTemp,
                        cleanCache: cleanCache,
                        cleanLogs: cleanLogs,
                        cleanOldBackups: cleanOldBackups
                    })
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess(`æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾ç©ºé—? ${formatSize(result.data.freedSpace)}`);
                    loadStorageStatus();
                } else {
                    showError('æ¸…ç†å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¸…ç†é”™è¯¯:', error);
                showError('æ¸…ç†å¤±è´¥');
            }
        }

        async function saveSettings() {
            const storagePath = document.getElementById('storage-path').value;
            const maxStorage = document.getElementById('max-storage').value;
            const backupRetention = document.getElementById('backup-retention').value;
            const autoBackup = document.getElementById('auto-backup').value;
            
            try {
                const response = await fetch('/api/admin/storage/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        storagePath: storagePath,
                        maxStorage: maxStorage,
                        backupRetention: backupRetention,
                        autoBackup: autoBackup
                    })
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                if (result.status === 'success') {
                    showSuccess('è®¾ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    showError('è®¾ç½®ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®é”™è¯¯:', error);
                showError('è®¾ç½®ä¿å­˜å¤±è´¥');
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>
