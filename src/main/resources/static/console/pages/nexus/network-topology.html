<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络拓扑 - Nexus Console</title>
    
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/nexus.css">
</head>
<body>
    <div class="nx-page">
        <aside class="nx-page__sidebar">
            <div class="nx-p-4 nx-mb-4">
                <h1 class="nx-text-lg nx-font-bold" style="display: flex; align-items: center; gap: 8px;">
                    <i class="ri-server-line"></i> Nexus Console
                </h1>
            </div>
            <ul class="nav-menu" id="nav-menu"></ul>
        </aside>
        
        <main class="nx-page__content">
            <header class="nx-page__header">
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-sidebar-toggle>
                        <i class="ri-menu-line"></i>
                    </button>
                    <h2 class="nx-text-lg nx-font-semibold">网络拓扑</h2>
                </div>
                <div class="nx-flex nx-items-center nx-gap-3">
                    <button class="nx-btn nx-btn--ghost nx-btn--icon" data-nx-theme-toggle>
                        <i class="ri-sun-line"></i>
                    </button>
                    <button class="nx-btn nx-btn--secondary" onclick="exportTopology()">
                        <i class="ri-download-line"></i> 导出
                    </button>
                    <button class="nx-btn nx-btn--primary" onclick="refreshTopology()">
                        <i class="ri-refresh-line"></i> 刷新
                    </button>
                </div>
            </header>
            
            <div class="nx-page__main">
                <div class="nx-container">
                    <div class="nx-grid nx-grid-cols-4 nx-mb-6">
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--primary">
                                <i class="ri-node-tree-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">节点总数</div>
                                <div class="nx-stat-card__value" id="totalNodes">0</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--success">
                                <i class="ri-link-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">连接总数</div>
                                <div class="nx-stat-card__value" id="totalConnections">0</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--warning">
                                <i class="ri-router-wireless-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">活跃节点</div>
                                <div class="nx-stat-card__value" id="activeNodes">0</div>
                            </div>
                        </div>
                        <div class="nx-stat-card">
                            <div class="nx-stat-card__icon nx-stat-card__icon--info">
                                <i class="ri-signal-line"></i>
                            </div>
                            <div class="nx-stat-card__content">
                                <div class="nx-stat-card__label">网络状态</div>
                                <div class="nx-stat-card__value" id="networkStatus">正常</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nx-card">
                        <div class="nx-card__header">
                            <h3 class="nx-card__title">拓扑可视化</h3>
                        </div>
                        <div class="nx-card__body">
                            <div id="topologyGraph" style="width: 100%; height: 400px; background: var(--nx-bg-elevated); border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                                <svg width="100%" height="100%" viewBox="0 0 800 400" id="topologySvg">
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/console/js/nexus.js"></script>
    <script src="/console/js/nexus-menu.js"></script>
    <script src="/console/js/page-init.js" data-auto-init></script>
    <script>
        const topologyData = {
            nodes: [
                { id: 'mcp-001', name: '主Nexus', type: 'mcp', x: 400, y: 80, status: 'active' },
                { id: 'route-001', name: '路由代理1', type: 'route', x: 250, y: 200, status: 'active' },
                { id: 'route-002', name: '路由代理2', type: 'route', x: 550, y: 200, status: 'active' },
                { id: 'end-001', name: '智能灯泡', type: 'end', x: 150, y: 320, status: 'active' },
                { id: 'end-002', name: '智能插座', type: 'end', x: 350, y: 320, status: 'active' },
                { id: 'end-003', name: '摄像头', type: 'end', x: 450, y: 320, status: 'inactive' },
                { id: 'end-004', name: '智能音箱', type: 'end', x: 650, y: 320, status: 'active' }
            ],
            connections: [
                { source: 'mcp-001', target: 'route-001', status: 'active' },
                { source: 'mcp-001', target: 'route-002', status: 'active' },
                { source: 'route-001', target: 'end-001', status: 'active' },
                { source: 'route-001', target: 'end-002', status: 'active' },
                { source: 'route-002', target: 'end-003', status: 'inactive' },
                { source: 'route-002', target: 'end-004', status: 'active' }
            ]
        };
        
        window.onPageInit = function() {
            console.log('网络拓扑页面初始化完成');
            renderTopology();
            updateStatusOverview();
        };
        
        function renderTopology() {
            const svg = document.getElementById('topologySvg');
            svg.innerHTML = '';
            
            topologyData.connections.forEach(conn => {
                const source = topologyData.nodes.find(n => n.id === conn.source);
                const target = topologyData.nodes.find(n => n.id === conn.target);
                if (source && target) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', source.x);
                    line.setAttribute('y1', source.y);
                    line.setAttribute('x2', target.x);
                    line.setAttribute('y2', target.y);
                    line.setAttribute('stroke', conn.status === 'active' ? '#22c55e' : '#ef4444');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                }
            });
            
            topologyData.nodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x);
                circle.setAttribute('cy', node.y);
                circle.setAttribute('r', '25');
                circle.setAttribute('fill', getNodeColor(node.type));
                circle.setAttribute('stroke', node.status === 'active' ? '#22c55e' : '#ef4444');
                circle.setAttribute('stroke-width', '3');
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x);
                text.setAttribute('y', node.y + 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', '12');
                text.textContent = node.name.substring(0, 4);
                
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', node.x);
                label.setAttribute('y', node.y + 45);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', 'var(--nx-text-primary)');
                label.setAttribute('font-size', '11');
                label.textContent = node.name;
                
                g.appendChild(circle);
                g.appendChild(text);
                g.appendChild(label);
                svg.appendChild(g);
            });
        }
        
        function getNodeColor(type) {
            const colors = { mcp: '#3b82f6', route: '#22c55e', end: '#f59e0b', gateway: '#8b5cf6' };
            return colors[type] || '#64748b';
        }
        
        function updateStatusOverview() {
            document.getElementById('totalNodes').textContent = topologyData.nodes.length;
            document.getElementById('totalConnections').textContent = topologyData.connections.length;
            document.getElementById('activeNodes').textContent = topologyData.nodes.filter(n => n.status === 'active').length;
        }
        
        function refreshTopology() {
            renderTopology();
        }
        
        function exportTopology() {
            const data = JSON.stringify(topologyData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'network-topology.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
