<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åè®®ç®¡ç† - Nexus - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">`n    <link rel="stylesheet" href="/console/css/theme.css">`n    <link rel="stylesheet" href="/console/css/dashboard.css">`n    <link rel="stylesheet" href="/console/css/styles.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <link rel="stylesheet" href="/console/css/mcpagent/common.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/theme-manager.js"></script>`n    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body class="nexus-page">
    <div class="nexus-container">
        <!-- ä¾§è¾¹å¯¼èˆªæ ?-->
        <div class="nexus-sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="nexus-main-content">
            <div class="nexus-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h1><i class="ri-network-line"></i> åè®®ç®¡ç†</h1>
                    <button class="theme-toggle-btn nexus-btn nexus-btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                        <i class="ri-sun-line"></i> æµ…è‰²æ¨¡å¼
                    </button>
                </div>
                <div class="subtitle">
                    <span class="badge nexus-badge">Nexus</span>
                    <span>ç®¡ç†å’Œå¤„ç†Nexusåè®®å‘½ä»¤</span>
                </div>
            </div>

            <!-- åè®®æ“ä½œåŒ?-->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>åè®®æ“ä½œ</h3>
                    <button class="nexus-btn nexus-btn-primary" onclick="showAddProtocolModal()">
                        <i class="ri-add-circle-line"></i>
                        æ³¨å†Œåè®®å¤„ç†å™?                    </button>
                </div>
                <div class="nexus-operation-card">
                    <div class="nexus-form-group">
                        <label for="commandType">å‘½ä»¤ç±»å‹</label>
                        <input type="text" id="commandType" placeholder="è¾“å…¥å‘½ä»¤ç±»å‹">
                    </div>
                    <div class="nexus-form-group">
                        <label for="handlerName">å¤„ç†å™¨åç§?/label>
                        <input type="text" id="handlerName" placeholder="è¾“å…¥å¤„ç†å™¨åç§?>
                    </div>
                    <div class="nexus-form-group">
                        <label for="handlerDescription">å¤„ç†å™¨æè¿?/label>
                        <textarea id="handlerDescription" placeholder="è¾“å…¥å¤„ç†å™¨æè¿?></textarea>
                    </div>
                    <div class="nexus-operation-buttons">
                        <button class="nexus-btn nexus-btn-primary" onclick="registerProtocolHandler()">æ³¨å†Œå¤„ç†å™?/button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="removeProtocolHandler()">ç§»é™¤å¤„ç†å™?/button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="handleProtocolCommand()">å¤„ç†å‘½ä»¤</button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="refreshProtocolHandlers()">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>
            </section>

            <!-- åè®®å¤„ç†å™¨åˆ—è¡?-->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>åè®®å¤„ç†å™¨åˆ—è¡?/h3>
                    <div class="search-box">
                        <input type="text" id="protocolSearch" placeholder="æœç´¢å‘½ä»¤ç±»å‹...">
                        <button class="nexus-btn nexus-btn-secondary" onclick="searchProtocolHandlers()"><i class="ri-search-line"></i></button>
                    </div>
                </div>
                <div class="nexus-card">
                    <table class="nexus-data-table">
                        <thead>
                            <tr>
                                <th>å‘½ä»¤ç±»å‹</th>
                                <th>å¤„ç†å™¨åç§?/th>
                                <th>å¤„ç†å™¨æè¿?/th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>çŠ¶æ€?/th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="protocolTableBody">
                            <!-- åè®®å¤„ç†å™¨æ•°æ®å°†é€šè¿‡JSåŠ¨æ€å¡«å…?-->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- å‘½ä»¤å¤„ç† -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>å‘½ä»¤å¤„ç†</h3>
                </div>
                <div class="nexus-card">
                    <div class="nexus-form-group">
                        <label for="commandData">å‘½ä»¤æ•°æ® (JSON)</label>
                        <textarea id="commandData" placeholder='è¾“å…¥å‘½ä»¤æ•°æ®ï¼Œä¾‹å¦? {"agentId": "test-agent", "data": {}}'></textarea>
                    </div>
                    <div class="nexus-operation-buttons">
                        <button class="nexus-btn nexus-btn-primary" onclick="handleProtocolCommand()">å¤„ç†å‘½ä»¤</button>
                        <button class="nexus-btn nexus-btn-secondary" onclick="clearCommandData()">æ¸…ç©ºæ•°æ®</button>
                    </div>
                </div>
            </section>

            <!-- å¤„ç†ç»“æœ -->
            <section class="nexus-operation-section">
                <div class="nexus-section-header">
                    <h3>å¤„ç†ç»“æœ</h3>
                </div>
                <div class="nexus-card">
                    <pre id="processingResult">å¤„ç†å‘½ä»¤ä»¥æŸ¥çœ‹ç»“æ?..</pre>
                </div>
            </section>
        </div>
    </div>

    <!-- Nexusæ¨¡å—ä¾èµ– -->
    <script src="/console/js/nexus/base.js"></script>
    <script src="/console/js/nexus/api.js"></script>
    <script src="/console/js/nexus/ui.js"></script>
    <script src="/console/js/nexus/utils.js"></script>
    <script src="/console/js/nexus/sdk-proxy.js"></script>
    <script src="/console/js/nexus/common.js"></script>
    <script>
        window.onPageInit = function() {
            // åˆå§‹åŒ–é¡µé?            nexusCommon.initPage('protocol-management', loadProtocolHandlers);
        };

        // åè®®å¤„ç†å™¨æ•°æ?        let protocolHandlers = [];

        async function loadProtocolHandlers() {
            try {
                // ä»åå°APIè·å–åè®®å¤„ç†å™¨åˆ—è¡?                const response = await fetch('/api/command/queue');
                const result = await response.json();

                if (result.code === 200 && result.data) {
                    // è½¬æ¢å‘½ä»¤é˜Ÿåˆ—ä¸ºåè®®å¤„ç†å™¨æ ¼å¼
                    const commands = result.data.commands || [];
                    protocolHandlers = commands.map(cmd => ({
                        commandType: cmd.type || 'UNKNOWN',
                        name: cmd.name || cmd.type || 'æœªå‘½åå¤„ç†å™¨',
                        description: cmd.description || `å¤„ç†${cmd.type}å‘½ä»¤`,
                        registeredTime: cmd.timestamp || new Date().toISOString(),
                        status: cmd.status === 'pending' ? 'active' : 'inactive'
                    }));
                    
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ?                    if (protocolHandlers.length === 0) {
                        protocolHandlers = getDefaultProtocolHandlers();
                    }
                    
                    renderProtocolHandlers();
                } else {
                    // APIå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ•°æ?                    protocolHandlers = getDefaultProtocolHandlers();
                    renderProtocolHandlers();
                }
            } catch (error) {
                console.error('åŠ è½½åè®®å¤„ç†å™¨åˆ—è¡¨å¤±è´?', error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                protocolHandlers = getDefaultProtocolHandlers();
                renderProtocolHandlers();
                nexusCommon.handleApiError(error, 'åŠ è½½åè®®å¤„ç†å™¨åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            }
        }
        
        // è·å–é»˜è®¤åè®®å¤„ç†å™?        function getDefaultProtocolHandlers() {
            return [
                {
                    commandType: "MCP_REGISTER",
                    name: "æ³¨å†Œå‘½ä»¤å¤„ç†å™?,
                    description: "å¤„ç†Nexusæ³¨å†Œå‘½ä»¤",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    commandType: "MCP_DEREGISTER",
                    name: "æ³¨é”€å‘½ä»¤å¤„ç†å™?,
                    description: "å¤„ç†Nexusæ³¨é”€å‘½ä»¤",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    commandType: "MCP_HEARTBEAT",
                    name: "å¿ƒè·³å‘½ä»¤å¤„ç†å™?,
                    description: "å¤„ç†Nexuså¿ƒè·³å‘½ä»¤",
                    registeredTime: new Date().toISOString(),
                    status: "active"
                },
                {
                    commandType: "MCP_STATUS",
                    name: "çŠ¶æ€å‘½ä»¤å¤„ç†å™¨",
                    description: "å¤„ç†NexusçŠ¶æ€å‘½ä»?,
                    registeredTime: new Date().toISOString(),
                    status: "active"
                }
            ];
        }

        function renderProtocolHandlers() {
            const tbody = document.getElementById('protocolTableBody');
            tbody.innerHTML = '';

            protocolHandlers.forEach(handler => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${handler.commandType}</td>
                    <td>${handler.name}</td>
                    <td>${handler.description}</td>
                    <td>${new Date(handler.registeredTime).toLocaleString()}</td>
                    <td><span class="nexus-status-badge nexus-status-${handler.status}">${handler.status === 'active' ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                    <td>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectProtocolHandler('${handler.commandType}')">é€‰æ‹©</button>
                        <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeProtocolHandlerByType('${handler.commandType}')">ç§»é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function registerProtocolHandler() {
            try {
                const commandType = document.getElementById('commandType').value;
                const handlerName = document.getElementById('handlerName').value;
                const handlerDescription = document.getElementById('handlerDescription').value;

                if (!commandType) {
                    nexusCommon.showMessage('è¯·è¾“å…¥å‘½ä»¤ç±»å?, 'warning');
                    return;
                }

                // æ£€æŸ¥å‘½ä»¤ç±»å‹æ˜¯å¦å·²å­˜åœ¨
                const existingHandler = protocolHandlers.find(h => h.commandType === commandType);
                if (existingHandler) {
                    nexusCommon.showMessage('å‘½ä»¤ç±»å‹å·²å­˜åœ?, 'warning');
                    return;
                }

                // æ¨¡æ‹ŸAPIè¯·æ±‚
                const mockResponse = {
                    status: 'success',
                    message: 'åè®®å¤„ç†å™¨æ³¨å†ŒæˆåŠ?,
                    data: {
                        commandType: commandType,
                        name: handlerName || commandType,
                        description: handlerDescription || 'æ— æè¿?,
                        registeredTime: new Date().toISOString(),
                        status: 'active'
                    },
                    timestamp: new Date().getTime()
                };

                // éªŒè¯APIè¿”å›æ ¼å¼
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success' && validatedResponse.data) {
                    protocolHandlers.push(validatedResponse.data);
                    renderProtocolHandlers();
                    clearProtocolForm();
                    nexusCommon.handleApiSuccess(validatedResponse);
                }
            } catch (error) {
                console.error('æ³¨å†Œåè®®å¤„ç†å™¨å¤±è´?', error);
                nexusCommon.handleApiError(error, 'æ³¨å†Œåè®®å¤„ç†å™¨å¤±è´?);
            }
        }

        function removeProtocolHandler() {
            const commandType = document.getElementById('commandType').value;
            if (!commandType) {
                nexusCommon.showMessage('è¯·è¾“å…¥å‘½ä»¤ç±»å?, 'warning');
                return;
            }
            removeProtocolHandlerByType(commandType);
        }

        async function removeProtocolHandlerByType(commandType) {
            try {
                const index = protocolHandlers.findIndex(h => h.commandType === commandType);
                if (index === -1) {
                    nexusCommon.showMessage('å‘½ä»¤å¤„ç†å™¨ä¸å­˜åœ¨', 'warning');
                    return;
                }

                // æ¨¡æ‹ŸAPIè¯·æ±‚
                const mockResponse = {
                    status: 'success',
                    message: 'åè®®å¤„ç†å™¨ç§»é™¤æˆåŠ?,
                    timestamp: new Date().getTime()
                };

                // éªŒè¯APIè¿”å›æ ¼å¼
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success') {
                    protocolHandlers.splice(index, 1);
                    renderProtocolHandlers();
                    nexusCommon.handleApiSuccess(validatedResponse);
                }
            } catch (error) {
                console.error('ç§»é™¤åè®®å¤„ç†å™¨å¤±è´?', error);
                nexusCommon.handleApiError(error, 'ç§»é™¤åè®®å¤„ç†å™¨å¤±è´?);
            }
        }

        async function handleProtocolCommand() {
            try {
                const commandType = document.getElementById('commandType').value;
                const commandData = document.getElementById('commandData').value;

                if (!commandType) {
                    nexusCommon.showMessage('è¯·è¾“å…¥å‘½ä»¤ç±»å?, 'warning');
                    return;
                }

                // æ£€æŸ¥å‘½ä»¤å¤„ç†å™¨æ˜¯å¦å­˜åœ¨
                const handler = protocolHandlers.find(h => h.commandType === commandType);
                if (!handler) {
                    nexusCommon.showMessage('å‘½ä»¤å¤„ç†å™¨ä¸å­˜åœ¨', 'warning');
                    return;
                }

                // è§£æå‘½ä»¤æ•°æ®
                let data = {};
                if (commandData) {
                    try {
                        data = JSON.parse(commandData);
                    } catch (e) {
                        nexusCommon.showMessage('å‘½ä»¤æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                        return;
                    }
                }

                // æ¨¡æ‹ŸAPIè¯·æ±‚
                const mockResponse = {
                    status: 'success',
                    message: 'å‘½ä»¤å¤„ç†æˆåŠŸ',
                    data: {
                        commandType: commandType,
                        handlerName: handler.name,
                        commandData: data,
                        result: `å‘½ä»¤ ${commandType} å¤„ç†æˆåŠŸ`,
                        timestamp: new Date().toISOString()
                    },
                    timestamp: new Date().getTime()
                };

                // éªŒè¯APIè¿”å›æ ¼å¼
                const validatedResponse = nexusCommon.validateApiResponse(mockResponse);

                if (validatedResponse.status === 'success' && validatedResponse.data) {
                    document.getElementById('processingResult').textContent = JSON.stringify(validatedResponse.data, null, 2);
                    nexusCommon.handleApiSuccess(validatedResponse);
                }
            } catch (error) {
                console.error('å¤„ç†å‘½ä»¤å¤±è´¥:', error);
                nexusCommon.handleApiError(error, 'å¤„ç†å‘½ä»¤å¤±è´¥');
            }
        }

        function selectProtocolHandler(commandType) {
            const handler = protocolHandlers.find(h => h.commandType === commandType);
            if (handler) {
                document.getElementById('commandType').value = handler.commandType;
                document.getElementById('handlerName').value = handler.name;
                document.getElementById('handlerDescription').value = handler.description;
            }
        }

        async function refreshProtocolHandlers() {
            try {
                await loadProtocolHandlers();
                nexusCommon.showMessage('åè®®å¤„ç†å™¨åˆ—è¡¨å·²åˆ·æ–°', 'success');
            } catch (error) {
                console.error('åˆ·æ–°åè®®å¤„ç†å™¨åˆ—è¡¨å¤±è´?', error);
                nexusCommon.handleApiError(error, 'åˆ·æ–°åè®®å¤„ç†å™¨åˆ—è¡¨å¤±è´?);
            }
        }

        async function searchProtocolHandlers() {
            try {
                const searchTerm = document.getElementById('protocolSearch').value.toLowerCase();
                const filteredHandlers = protocolHandlers.filter(h => 
                    h.commandType.toLowerCase().includes(searchTerm) ||
                    h.name.toLowerCase().includes(searchTerm)
                );

                const tbody = document.getElementById('protocolTableBody');
                tbody.innerHTML = '';

                filteredHandlers.forEach(handler => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${handler.commandType}</td>
                        <td>${handler.name}</td>
                        <td>${handler.description}</td>
                        <td>${new Date(handler.registeredTime).toLocaleString()}</td>
                        <td><span class="nexus-status-badge nexus-status-${handler.status}">${handler.status === 'active' ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                        <td>
                            <button class="nexus-btn nexus-btn-sm nexus-btn-primary" onclick="selectProtocolHandler('${handler.commandType}')">é€‰æ‹©</button>
                            <button class="nexus-btn nexus-btn-sm nexus-btn-danger" onclick="removeProtocolHandlerByType('${handler.commandType}')">ç§»é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('æœç´¢åè®®å¤„ç†å™¨å¤±è´?', error);
                nexusCommon.handleApiError(error, 'æœç´¢åè®®å¤„ç†å™¨å¤±è´?);
            }
        }

        function clearProtocolForm() {
            document.getElementById('commandType').value = '';
            document.getElementById('handlerName').value = '';
            document.getElementById('handlerDescription').value = '';
        }

        function clearCommandData() {
            document.getElementById('commandData').value = '';
        }

        function showAddProtocolModal() {
            // è¿™é‡Œå¯ä»¥å®ç°æ¨¡æ€æ¡†é€»è¾‘
            nexusCommon.showMessage('æ³¨å†Œåè®®å¤„ç†å™¨åŠŸèƒ?, 'info');
        }
    </script>
</body>
</html>
