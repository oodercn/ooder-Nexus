<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑名单管理 - OpenWrt - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="ri-shield-cross-line"></i> 黑名单管理</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="history.back()">
                        <i class="ri-arrow-left-line"></i> 返回
                    </button>
                    <button class="btn btn-primary" onclick="showAddBlacklistModal()">
                        <i class="ri-add-line"></i> 添加黑名单
                    </button>
                </div>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);">
                        <i class="ri-shield-cross-line"></i>
                    </div>
                    <div class="status-value" id="blacklistCount">0</div>
                    <div class="status-label">黑名单数量</div>
                </div>
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);">
                        <i class="ri-shield-check-line"></i>
                    </div>
                    <div class="status-value" id="enabledCount">0</div>
                    <div class="status-label">已启用</div>
                </div>
            </div>
            
            <!-- 黑名单列表 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-list-check"></i> 黑名单列表</h2>
                    <button class="btn btn-secondary" onclick="loadBlacklist()">
                        <i class="ri-refresh-line"></i> 刷新
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="blacklistTable">
                            <thead>
                                <tr>
                                    <th>IP 地址</th>
                                    <th>名称</th>
                                    <th>来源</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistTableBody">
                                <!-- 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加黑名单模态框 -->
    <div id="addBlacklistModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">添加黑名单</h3>
                <button class="modal-close" onclick="hideAddBlacklistModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">IP 地址</label>
                    <input type="text" id="blacklistIp" class="form-input" placeholder="192.168.1.200">
                </div>
                <div class="form-group">
                    <label class="form-label">名称</label>
                    <input type="text" id="blacklistName" class="form-input" placeholder="例如：可疑设备">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddBlacklistModal()">取消</button>
                <button class="btn btn-primary" onclick="addBlacklist()">添加</button>
            </div>
        </div>
    </div>

    <script src="/console/common/api-client.js"></script>
    <script src="/console/common/button-manager.js"></script>
    <script src="/console/common/utils.js"></script>
    <script>
        // API 客户端实例
        const openwrtApi = new ApiClient('/api/openwrt');

        // 页面初始化
        window.onPageInit = function() {
            loadBlacklist();
        };

        // 加载黑名单列表
        async function loadBlacklist() {
            try {
                const data = await openwrtApi.get('/blacklist');

                if (data.status === 'success') {
                    renderBlacklistTable(data.data || []);
                    updateStats(data.data || []);
                }
            } catch (error) {
                console.error('加载黑名单失败:', error);
                showToast('加载黑名单失败', 'error');
            }
        }

        // 渲染黑名单表格
        function renderBlacklistTable(blacklist) {
            const tbody = document.getElementById('blacklistTableBody');
            tbody.innerHTML = '';

            if (!blacklist || blacklist.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">暂无黑名单</td></tr>';
                return;
            }

            blacklist.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.ip || '-'}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.source || '*'}</td>
                    <td>
                        <span class="badge ${item.enabled ? 'badge-success' : 'badge-secondary'}">
                            ${item.enabled ? '已启用' : '已禁用'}
                        </span>
                    </td>
                    <td>${formatDate(item.created)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeBlacklist('${item.id}')">
                            <i class="ri-delete-bin-line"></i> 移除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 更新统计
        function updateStats(blacklist) {
            document.getElementById('blacklistCount').textContent = blacklist.length;
            document.getElementById('enabledCount').textContent = blacklist.filter(item => item.enabled).length;
        }

        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // 显示添加黑名单模态框
        function showAddBlacklistModal() {
            document.getElementById('addBlacklistModal').style.display = 'flex';
        }

        // 隐藏添加黑名单模态框
        function hideAddBlacklistModal() {
            document.getElementById('addBlacklistModal').style.display = 'none';
            document.getElementById('blacklistIp').value = '';
            document.getElementById('blacklistName').value = '';
        }

        // 添加黑名单
        async function addBlacklist() {
            const ip = document.getElementById('blacklistIp').value;
            const name = document.getElementById('blacklistName').value;

            if (!ip) {
                showToast('请填写 IP 地址', 'warning');
                return;
            }

            try {
                const data = await openwrtApi.post('/blacklist', {
                    ip: ip,
                    name: name || 'Blocked Device'
                });

                if (data.status === 'success') {
                    showToast('黑名单添加成功', 'success');
                    hideAddBlacklistModal();
                    loadBlacklist();
                } else {
                    showToast('添加失败: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('添加黑名单失败:', error);
                showToast('添加失败', 'error');
            }
        }

        // 移除黑名单
        async function removeBlacklist(id) {
            if (!confirm('确定要移除此黑名单吗？')) {
                return;
            }

            try {
                const data = await openwrtApi.delete(`/blacklist/${id}`);

                if (data.status === 'success') {
                    showToast('移除成功', 'success');
                    loadBlacklist();
                } else {
                    showToast('移除失败: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('移除黑名单失败:', error);
                showToast('移除失败', 'error');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#52c41a' : type === 'error' ? '#ff4d4f' : type === 'warning' ? '#faad14' : '#1890ff'};
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
