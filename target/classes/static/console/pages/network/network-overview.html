<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络概览 - Nexus</title>
    <link rel="stylesheet" href="/console/css/remixicon/remixicon.css">
    <link rel="stylesheet" href="/console/css/theme.css">
    <script src="/console/js/theme-manager.js"></script>
    <script src="/console/js/menu-loader.js"></script>
    <script src="/console/js/common.js"></script>
</head>
<body>
    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <h2 style="display: flex; align-items: center; gap: 12px;"><i class="ri-server-line"></i> Nexus Console</h2>
            <ul class="nav-menu" id="nav-menu"></ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="ri-dashboard-line"></i> 网络概览</h1>
                <div class="header-actions">
                    <button id="deviceSelector" class="btn btn-secondary" onclick="showDeviceSelector()">
                        <i class="ri-router-line"></i> <span id="currentDevice">主路由器</span>
                    </button>
                    <button id="mockToggleBtn" class="btn btn-secondary" onclick="toggleMockMode()">
                        <i class="ri-bug-line"></i> 模拟模式
                    </button>
                    <button class="theme-toggle-btn btn btn-secondary">
                        <i class="ri-sun-line"></i> 浅色模式
                    </button>
                    <button id="refresh-btn" class="btn btn-primary" onclick="refreshData()">
                        <i class="ri-refresh-line"></i> 刷新数据
                    </button>
                </div>
            </div>
            
            <!-- 设备状态概览 -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="ri-router-line"></i>
                    </div>
                    <div class="status-value" id="deviceCount">3</div>
                    <div class="status-label">网络设备</div>
                </div>
                
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="ri-wifi-line"></i>
                    </div>
                    <div class="status-value" id="onlineDevices">12</div>
                    <div class="status-label">在线设备</div>
                </div>
                
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="ri-speed-line"></i>
                    </div>
                    <div class="status-value" id="bandwidthUsage">45%</div>
                    <div class="status-label">带宽使用</div>
                </div>
                
                <div class="card status-card">
                    <div class="status-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="ri-shield-check-line"></i>
                    </div>
                    <div class="status-value" id="securityStatus">正常</div>
                    <div class="status-label">安全状态</div>
                </div>
            </div>
            
            <!-- 连接状态卡片 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-router-line"></i> 设备连接状态</h2>
                    <span id="connectionStatus" class="status-badge status-online">已连接</span>
                </div>
                <div id="deviceInfo">
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 15px;">
                        <div class="info-item">
                            <span class="info-label">设备地址</span>
                            <span id="deviceHost" class="info-value">192.168.1.1</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">固件版本</span>
                            <span id="firmwareVersion" class="info-value">OpenWrt 21.02.3</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">运行时间</span>
                            <span id="uptime" class="info-value">15天 3小时</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">设备型号</span>
                            <span id="deviceModel" class="info-value">Xiaomi AX3600</span>
                        </div>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="connectBtn" class="btn btn-primary" onclick="showConnectModal()" style="display: none;">
                        <i class="ri-link"></i> 连接设备
                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" onclick="disconnectDevice()">
                        <i class="ri-unlink"></i> 断开连接
                    </button>
                    <button id="rebootBtn" class="btn btn-warning" onclick="rebootDevice()">
                        <i class="ri-restart-line"></i> 重启设备
                    </button>
                </div>
            </div>
            
            <!-- 网络拓扑 -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title"><i class="ri-global-line"></i> 网络拓扑</h2>
                    <button class="btn btn-secondary" onclick="viewFullTopology()">
                        <i class="ri-fullscreen-line"></i> 查看完整拓扑
                    </button>
                </div>
                <div class="network-topology" style="height: 300px;">
                    <div class="topology-diagram" style="height: 100%;">
                        <svg width="100%" height="100%" viewBox="0 0 800 250">
                            <!-- 路由器 -->
                            <circle cx="400" cy="50" r="30" fill="var(--nexus-primary)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="400" y="55" text-anchor="middle" fill="white" font-size="14" font-weight="600">路由器</text>
                            
                            <!-- 交换机 -->
                            <rect x="300" y="120" width="200" height="40" rx="5" fill="var(--nexus-secondary)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="400" y="145" text-anchor="middle" fill="white" font-size="14" font-weight="600">交换机</text>
                            
                            <!-- 设备1 -->
                            <rect x="150" y="200" width="100" height="30" rx="5" fill="var(--nexus-success)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="200" y="220" text-anchor="middle" fill="white" font-size="12">PC 1</text>
                            
                            <!-- 设备2 -->
                            <rect x="300" y="200" width="100" height="30" rx="5" fill="var(--nexus-success)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="350" y="220" text-anchor="middle" fill="white" font-size="12">PC 2</text>
                            
                            <!-- 设备3 -->
                            <rect x="450" y="200" width="100" height="30" rx="5" fill="var(--nexus-warning)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="500" y="220" text-anchor="middle" fill="white" font-size="12">打印机</text>
                            
                            <!-- 设备4 -->
                            <rect x="600" y="200" width="100" height="30" rx="5" fill="var(--nexus-danger)" stroke="var(--nexus-dark)" stroke-width="2" />
                            <text x="650" y="220" text-anchor="middle" fill="white" font-size="12">NAS</text>
                            
                            <!-- 连接线 -->
                            <line x1="400" y1="80" x2="400" y2="120" stroke="var(--nexus-dark)" stroke-width="2" />
                            <line x1="300" y1="160" x2="200" y2="200" stroke="var(--nexus-dark)" stroke-width="2" />
                            <line x1="350" y1="160" x2="350" y2="200" stroke="var(--nexus-dark)" stroke-width="2" />
                            <line x1="450" y1="160" x2="500" y2="200" stroke="var(--nexus-dark)" stroke-width="2" />
                            <line x1="500" y1="160" x2="650" y2="200" stroke="var(--nexus-dark)" stroke-width="2" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- 快捷操作 -->
            <h3 style="margin: 30px 0 15px; color: var(--nexus-text);">快捷操作</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="card status-card" onclick="navigateTo('network-config')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="ri-settings-3-line"></i>
                    </div>
                    <div class="status-value">网络配置</div>
                    <div class="status-label">配置网络参数</div>
                </div>
                <div class="card status-card" onclick="navigateTo('ip-management')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="ri-computer-line"></i>
                    </div>
                    <div class="status-value">IP地址管理</div>
                    <div class="status-label">管理IP地址分配</div>
                </div>
                <div class="card status-card" onclick="navigateTo('device-assets')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="ri-list-check"></i>
                    </div>
                    <div class="status-value">设备资产</div>
                    <div class="status-label">查看网络设备</div>
                </div>
                <div class="card status-card" onclick="navigateTo('traffic-monitor')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="ri-equalizer-line"></i>
                    </div>
                    <div class="status-value">流量监控</div>
                    <div class="status-label">监控带宽使用</div>
                </div>
                <div class="card status-card" onclick="navigateTo('access-control')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="ri-shield-cross-line"></i>
                    </div>
                    <div class="status-value">访问控制</div>
                    <div class="status-label">管理访问权限</div>
                </div>
                <div class="card status-card" onclick="navigateTo('remote-terminal')" style="cursor: pointer;">
                    <div class="status-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="ri-terminal-line"></i>
                    </div>
                    <div class="status-value">远程终端</div>
                    <div class="status-label">执行远程命令</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设备选择器模态框 -->
    <div id="deviceSelectorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">选择网络设备</h3>
                <button class="modal-close" onclick="hideDeviceSelector()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="device-list" id="deviceList">
                    <div class="device-item" onclick="selectDevice('router1')" style="padding: 12px; border: 1px solid var(--nexus-border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="ri-router-line" style="font-size: 24px; color: var(--nexus-primary);"></i>
                            <div>
                                <div style="font-weight: 600;">主路由器</div>
                                <div style="font-size: 12px; color: var(--nexus-secondary);">192.168.1.1</div>
                            </div>
                        </div>
                    </div>
                    <div class="device-item" onclick="selectDevice('switch1')" style="padding: 12px; border: 1px solid var(--nexus-border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="ri-exchange-line" style="font-size: 24px; color: var(--nexus-secondary);"></i>
                            <div>
                                <div style="font-weight: 600;">核心交换机</div>
                                <div style="font-size: 12px; color: var(--nexus-secondary);">192.168.1.2</div>
                            </div>
                        </div>
                    </div>
                    <div class="device-item" onclick="selectDevice('ap1')" style="padding: 12px; border: 1px solid var(--nexus-border); border-radius: 8px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="ri-wifi-line" style="font-size: 24px; color: var(--nexus-success);"></i>
                            <div>
                                <div style="font-weight: 600;">无线AP</div>
                                <div style="font-size: 12px; color: var(--nexus-secondary);">192.168.1.3</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 连接模态框 -->
    <div id="connectModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">连接网络设备</h3>
                <button class="modal-close" onclick="hideConnectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">设备地址</label>
                    <input type="text" id="hostInput" class="form-input" placeholder="192.168.1.1" value="192.168.1.1">
                </div>
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" id="usernameInput" class="form-input" placeholder="root" value="root">
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="密码">
                </div>
                <div class="form-group">
                    <label class="form-label">设备类型</label>
                    <select id="deviceTypeInput" class="form-select">
                        <option value="openwrt">OpenWrt 路由器</option>
                        <option value="switch">交换机</option>
                        <option value="ap">无线AP</option>
                        <option value="other">其他设备</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideConnectModal()">取消</button>
                <button class="btn btn-primary" onclick="connectDevice()">连接</button>
            </div>
        </div>
    </div>

    <script>
        let currentDeviceId = 'router1';
        let isMockMode = false;
        
        // 页面初始化
        async function init() {
            await loadDeviceStats();
        }
        
        // 从API加载设备统计数据
        async function loadDeviceStats() {
            try {
                // 获取设备列表
                const devicesResponse = await fetch('/api/devices/list');
                const devicesResult = await devicesResponse.json();
                
                if (devicesResult.code === 200 && devicesResult.data) {
                    const stats = devicesResult.data.stats;
                    const devices = devicesResult.data.devices;
                    
                    // 更新统计卡片
                    document.getElementById('deviceCount').textContent = stats.total || 0;
                    document.getElementById('onlineDevices').textContent = stats.online || 0;
                    
                    // 更新设备列表
                    updateDeviceSelector(devices);
                }
                
                // 获取命令统计
                const statsResponse = await fetch('/api/command/stats');
                const statsResult = await statsResponse.json();
                
                if (statsResult.code === 200 && statsResult.data) {
                    // 可以在这里更新更多统计信息
                    console.log('命令统计:', statsResult.data);
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }
        
        // 更新设备选择器
        function updateDeviceSelector(devices) {
            const deviceList = document.getElementById('deviceList');
            if (!deviceList || devices.length === 0) return;
            
            deviceList.innerHTML = devices.slice(0, 5).map(device => `
                <div class="device-item" onclick="selectDevice('${device.id}')" style="padding: 12px; border: 1px solid var(--nexus-border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="ri-${getDeviceIcon(device.type)}" style="font-size: 24px; color: var(--nexus-primary);"></i>
                        <div>
                            <div style="font-weight: 600;">${device.name}</div>
                            <div style="font-size: 12px; color: var(--nexus-secondary);">${device.id}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 获取设备图标
        function getDeviceIcon(type) {
            const iconMap = {
                router: 'router-line',
                switch: 'exchange-line',
                pc: 'computer-line',
                printer: 'printer-line',
                nas: 'hard-drive-line',
                light: 'lightbulb-line',
                socket: 'plug-line',
                lock: 'lock-line',
                sensor: 'sensor-line',
                other: 'device-line'
            };
            return iconMap[type] || 'device-line';
        }

        // 显示设备选择器
        function showDeviceSelector() {
            document.getElementById('deviceSelectorModal').style.display = 'flex';
        }

        // 隐藏设备选择器
        function hideDeviceSelector() {
            document.getElementById('deviceSelectorModal').style.display = 'none';
        }

        // 选择设备
        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            const deviceNames = {
                'router1': '主路由器',
                'switch1': '核心交换机',
                'ap1': '无线AP'
            };
            document.getElementById('currentDevice').textContent = deviceNames[deviceId] || deviceId;
            hideDeviceSelector();
            refreshData();
        }

        // 显示连接模态框
        function showConnectModal() {
            document.getElementById('connectModal').style.display = 'flex';
        }

        // 隐藏连接模态框
        function hideConnectModal() {
            document.getElementById('connectModal').style.display = 'none';
        }

        // 连接设备
        function connectDevice() {
            const host = document.getElementById('hostInput').value;
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const deviceType = document.getElementById('deviceTypeInput').value;
            
            // 模拟连接
            setTimeout(() => {
                document.getElementById('connectionStatus').textContent = '已连接';
                document.getElementById('connectionStatus').className = 'status-badge status-online';
                document.getElementById('deviceHost').textContent = host;
                hideConnectModal();
                alert('设备连接成功！');
            }, 1000);
        }

        // 断开设备连接
        function disconnectDevice() {
            if (confirm('确定要断开设备连接吗？')) {
                document.getElementById('connectionStatus').textContent = '未连接';
                document.getElementById('connectionStatus').className = 'status-badge status-offline';
                alert('设备已断开连接');
            }
        }

        // 重启设备
        function rebootDevice() {
            if (confirm('确定要重启设备吗？')) {
                alert('设备重启命令已发送');
            }
        }

        // 刷新数据
        function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.innerHTML = '<i class="ri-refresh-line ri-spin"></i> 刷新中...';
            
            setTimeout(() => {
                btn.innerHTML = '<i class="ri-refresh-line"></i> 刷新数据';
                alert('数据已刷新');
            }, 1000);
        }

        // 切换模拟模式
        function toggleMockMode() {
            isMockMode = !isMockMode;
            const btn = document.getElementById('mockToggleBtn');
            if (isMockMode) {
                btn.classList.add('btn-warning');
                btn.innerHTML = '<i class="ri-bug-line"></i> 模拟模式: 开';
            } else {
                btn.classList.remove('btn-warning');
                btn.innerHTML = '<i class="ri-bug-line"></i> 模拟模式';
            }
        }

        // 页面导航
        function navigateTo(page) {
            window.location.href = page + '.html';
        }

        // 查看完整拓扑
        function viewFullTopology() {
            window.location.href = '/console/pages/nexus/network-topology.html';
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>
